<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹è±¡æ“ä½œ - TripoScript 2.1</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .viewport {
            flex: 1;
            position: relative;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        h1 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 24px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }

        .section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 8px;
            margin: 3px 0;
            border: none;
            border-radius: 4px;
            background: #e74c3c;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .object-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .object-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .object-item:hover {
            background: #f8f9fa;
        }

        .object-item.selected {
            background: #3498db;
            color: white;
        }

        .object-item:last-child {
            border-bottom: none;
        }

        .transform-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
        }

        .transform-controls input {
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            z-index: 1000;
        }

        .action-log {
            background: #2c3e50;
            color: #ecf0f1;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
            border-radius: 4px;
        }

        .properties {
            font-size: 12px;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
    
    <div class="container">
        <div class="sidebar">
            <h1>å¯¹è±¡æ“ä½œ</h1>
            
            <div class="section">
                <h3>ğŸ¯ åˆ›å»ºå¯¹è±¡</h3>
                <button onclick="createCube()">åˆ›å»ºç«‹æ–¹ä½“</button>
                <button onclick="createSphere()">åˆ›å»ºçƒä½“</button>
                <button onclick="createCylinder()">åˆ›å»ºåœ†æŸ±ä½“</button>
                <button onclick="createPlane()">åˆ›å»ºå¹³é¢</button>
                <button onclick="createGroup()">åˆ›å»ºç»„å¯¹è±¡</button>
            </div>

            <div class="section">
                <h3>ğŸ“‹ å¯¹è±¡åˆ—è¡¨</h3>
                <div class="object-list" id="objectList">
                    <!-- å¯¹è±¡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
                </div>
            </div>

            <div class="section">
                <h3>âœï¸ ç¼–è¾‘æ“ä½œ</h3>
                <button onclick="duplicateSelected()" id="duplicateBtn" disabled>å¤åˆ¶é€‰ä¸­å¯¹è±¡</button>
                <button onclick="deleteSelected()" id="deleteBtn" disabled>åˆ é™¤é€‰ä¸­å¯¹è±¡</button>
                <button onclick="groupSelected()" id="groupBtn" disabled>ç»„åˆé€‰ä¸­å¯¹è±¡</button>
                <button onclick="ungroupSelected()" id="ungroupBtn" disabled>å–æ¶ˆç»„åˆ</button>
            </div>

            <div class="section">
                <h3>ğŸ›ï¸ å˜æ¢æ§åˆ¶</h3>
                <div>ä½ç½® (X, Y, Z):</div>
                <div class="transform-controls">
                    <input type="number" id="posX" step="0.1" onchange="updateTransform()">
                    <input type="number" id="posY" step="0.1" onchange="updateTransform()">
                    <input type="number" id="posZ" step="0.1" onchange="updateTransform()">
                </div>
                <div>æ—‹è½¬ (X, Y, Z):</div>
                <div class="transform-controls">
                    <input type="number" id="rotX" step="0.1" onchange="updateTransform()">
                    <input type="number" id="rotY" step="0.1" onchange="updateTransform()">
                    <input type="number" id="rotZ" step="0.1" onchange="updateTransform()">
                </div>
                <div>ç¼©æ”¾ (X, Y, Z):</div>
                <div class="transform-controls">
                    <input type="number" id="scaleX" step="0.1" min="0.1" onchange="updateTransform()">
                    <input type="number" id="scaleY" step="0.1" min="0.1" onchange="updateTransform()">
                    <input type="number" id="scaleZ" step="0.1" min="0.1" onchange="updateTransform()">
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“Š å¯¹è±¡å±æ€§</h3>
                <div class="properties" id="properties">
                    é€‰æ‹©ä¸€ä¸ªå¯¹è±¡æŸ¥çœ‹å±æ€§
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“ Actionæ—¥å¿—</h3>
                <div class="action-log" id="actionLog">
                    DSLå¼•æ“å¯åŠ¨...<br>
                </div>
            </div>
        </div>

        <div class="viewport">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script type="module">
        import { TripoEngine, TripoRenderer } from '../../src/index.js';
        import { Vector3 } from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        // å…¨å±€å˜é‡
        let engine, renderer, controls;
        let selectedObjectId = null;
        let objectCount = 0;

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function init() {
            const canvas = document.getElementById('canvas');
            
            // åˆ›å»ºDSLå¼•æ“
            engine = new TripoEngine();
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new TripoRenderer(canvas, engine);
            
            // æ·»åŠ è½¨é“æ§åˆ¶å™¨
            controls = new OrbitControls(
                renderer.getThreeCamera(), 
                renderer.getThreeRenderer().domElement
            );
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // ç›‘å¬åœºæ™¯å˜åŒ–
            engine.subscribe(onSceneUpdate);
            
            // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            animate();
            
            logAction('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }

        // æ¸²æŸ“å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
        }

        // è®°å½•Actionæ—¥å¿—
        function logAction(message) {
            const log = document.getElementById('actionLog');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        // åœºæ™¯æ›´æ–°å›è°ƒ
        function onSceneUpdate(scene) {
            updateObjectList(scene);
            updateButtonStates(scene);
            updateProperties(scene);
        }

        // æ›´æ–°å¯¹è±¡åˆ—è¡¨
        function updateObjectList(scene) {
            const listElement = document.getElementById('objectList');
            listElement.innerHTML = '';
            
            scene.objects.forEach(obj => {
                const item = document.createElement('div');
                item.className = 'object-item';
                if (obj.id === selectedObjectId) {
                    item.classList.add('selected');
                }
                
                item.innerHTML = `
                    <strong>${obj.name}</strong><br>
                    <small>ç±»å‹: ${obj.type} | ID: ${obj.id.substring(0, 8)}...</small>
                `;
                
                item.onclick = () => selectObject(obj.id);
                listElement.appendChild(item);
            });
        }

        // é€‰æ‹©å¯¹è±¡
        function selectObject(objectId) {
            selectedObjectId = objectId;
            const scene = engine.getScene();
            engine.selectObjects([objectId], 'set');
            logAction(`é€‰æ‹©å¯¹è±¡: ${objectId}`);
            
            // æ›´æ–°å˜æ¢æ§åˆ¶å™¨
            const obj = scene.objects.find(o => o.id === objectId);
            if (obj) {
                document.getElementById('posX').value = obj.transform.position?.x || 0;
                document.getElementById('posY').value = obj.transform.position?.y || 0;
                document.getElementById('posZ').value = obj.transform.position?.z || 0;
                document.getElementById('rotX').value = obj.transform.rotation?.x || 0;
                document.getElementById('rotY').value = obj.transform.rotation?.y || 0;
                document.getElementById('rotZ').value = obj.transform.rotation?.z || 0;
                document.getElementById('scaleX').value = obj.transform.scale?.x || 1;
                document.getElementById('scaleY').value = obj.transform.scale?.y || 1;
                document.getElementById('scaleZ').value = obj.transform.scale?.z || 1;
            }
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates(scene) {
            const hasSelection = selectedObjectId && scene.objects.find(o => o.id === selectedObjectId);
            document.getElementById('duplicateBtn').disabled = !hasSelection;
            document.getElementById('deleteBtn').disabled = !hasSelection;
            document.getElementById('groupBtn').disabled = scene.selection.length < 2;
            document.getElementById('ungroupBtn').disabled = !hasSelection || scene.objects.find(o => o.id === selectedObjectId)?.type !== 'group';
        }

        // æ›´æ–°å±æ€§é¢æ¿
        function updateProperties(scene) {
            const props = document.getElementById('properties');
            
            if (!selectedObjectId) {
                props.innerHTML = 'é€‰æ‹©ä¸€ä¸ªå¯¹è±¡æŸ¥çœ‹å±æ€§';
                return;
            }
            
            const obj = scene.objects.find(o => o.id === selectedObjectId);
            if (!obj) {
                props.innerHTML = 'å¯¹è±¡ä¸å­˜åœ¨';
                return;
            }
            
            props.innerHTML = `
                <strong>åç§°:</strong> ${obj.name}<br>
                <strong>ç±»å‹:</strong> ${obj.type}<br>
                <strong>ID:</strong> ${obj.id}<br>
                <strong>å¯è§:</strong> ${obj.visible !== false ? 'æ˜¯' : 'å¦'}<br>
                <strong>æŠ•å°„é˜´å½±:</strong> ${obj.castShadow ? 'æ˜¯' : 'å¦'}<br>
                <strong>æ¥å—é˜´å½±:</strong> ${obj.receiveShadow ? 'æ˜¯' : 'å¦'}<br>
                <strong>å­å¯¹è±¡æ•°:</strong> ${obj.children?.length || 0}
            `;
        }

        // åˆ›å»ºç«‹æ–¹ä½“
        window.createCube = function() {
            const id = engine.addObject({
                name: `ç«‹æ–¹ä½“_${++objectCount}`,
                type: 'mesh',
                geometry: {
                    type: 'box',
                    size: new Vector3(1, 1, 1)
                },
                transform: {
                    position: new Vector3(Math.random() * 6 - 3, Math.random() * 6 - 3, Math.random() * 6 - 3)
                },
                material: { id: 'default' }
            });
            logAction(`åˆ›å»ºç«‹æ–¹ä½“: ${id}`);
            selectObject(id);
        };

        // åˆ›å»ºçƒä½“
        window.createSphere = function() {
            const id = engine.addObject({
                name: `çƒä½“_${++objectCount}`,
                type: 'mesh',
                geometry: {
                    type: 'sphere',
                    radius: 0.8,
                    radialSegments: 16,
                    heightSegments: 12
                },
                transform: {
                    position: new Vector3(Math.random() * 6 - 3, Math.random() * 6 - 3, Math.random() * 6 - 3)
                },
                material: { id: 'default' }
            });
            logAction(`åˆ›å»ºçƒä½“: ${id}`);
            selectObject(id);
        };

        // åˆ›å»ºåœ†æŸ±ä½“
        window.createCylinder = function() {
            const id = engine.addObject({
                name: `åœ†æŸ±ä½“_${++objectCount}`,
                type: 'mesh',
                geometry: {
                    type: 'cylinder',
                    radius: 0.8,
                    height: 2,
                    radialSegments: 16
                },
                transform: {
                    position: new Vector3(Math.random() * 6 - 3, Math.random() * 6 - 3, Math.random() * 6 - 3)
                },
                material: { id: 'default' }
            });
            logAction(`åˆ›å»ºåœ†æŸ±ä½“: ${id}`);
            selectObject(id);
        };

        // åˆ›å»ºå¹³é¢
        window.createPlane = function() {
            const id = engine.addObject({
                name: `å¹³é¢_${++objectCount}`,
                type: 'mesh',
                geometry: {
                    type: 'plane',
                    size: new Vector3(2, 2, 1)
                },
                transform: {
                    position: new Vector3(Math.random() * 6 - 3, Math.random() * 6 - 3, Math.random() * 6 - 3),
                    rotation: new Vector3(Math.random() * Math.PI, Math.random() * Math.PI, 0)
                },
                material: { id: 'default' }
            });
            logAction(`åˆ›å»ºå¹³é¢: ${id}`);
            selectObject(id);
        };

        // åˆ›å»ºç»„å¯¹è±¡
        window.createGroup = function() {
            const id = engine.addObject({
                name: `ç»„_${++objectCount}`,
                type: 'group',
                transform: {
                    position: new Vector3(0, 0, 0),
                    rotation: new Vector3(0, 0, 0),
                    scale: new Vector3(1, 1, 1)
                }
            });
            logAction(`åˆ›å»ºç»„å¯¹è±¡: ${id}`);
            selectObject(id);
        };

        // å¤åˆ¶é€‰ä¸­å¯¹è±¡
        window.duplicateSelected = function() {
            if (selectedObjectId) {
                engine.dispatch({
                    type: 'DUPLICATE_OBJECT',
                    payload: { id: selectedObjectId }
                });
                logAction(`å¤åˆ¶å¯¹è±¡: ${selectedObjectId}`);
            }
        };

        // åˆ é™¤é€‰ä¸­å¯¹è±¡
        window.deleteSelected = function() {
            if (selectedObjectId) {
                engine.removeObject(selectedObjectId);
                logAction(`åˆ é™¤å¯¹è±¡: ${selectedObjectId}`);
                selectedObjectId = null;
            }
        };

        // ç»„åˆé€‰ä¸­å¯¹è±¡
        window.groupSelected = function() {
            const scene = engine.getScene();
            if (scene.selection.length >= 2) {
                const groupId = engine.addObject({
                    name: `ç»„åˆ_${++objectCount}`,
                    type: 'group',
                    transform: {
                        position: new Vector3(0, 0, 0),
                        rotation: new Vector3(0, 0, 0),
                        scale: new Vector3(1, 1, 1)
                    }
                });
                
                // å°†é€‰ä¸­çš„å¯¹è±¡è®¾ä¸ºç»„çš„å­å¯¹è±¡
                scene.selection.forEach(objId => {
                    engine.updateObject(objId, { parent: groupId });
                });
                
                logAction(`ç»„åˆå¯¹è±¡: ${scene.selection.join(', ')}`);
                selectObject(groupId);
            }
        };

        // å–æ¶ˆç»„åˆ
        window.ungroupSelected = function() {
            if (selectedObjectId) {
                const scene = engine.getScene();
                const obj = scene.objects.find(o => o.id === selectedObjectId);
                
                if (obj && obj.type === 'group') {
                    // å–æ¶ˆå­å¯¹è±¡çš„çˆ¶çº§å…³ç³»
                    scene.objects.forEach(child => {
                        if (child.parent === selectedObjectId) {
                            engine.updateObject(child.id, { parent: undefined });
                        }
                    });
                    
                    // åˆ é™¤ç»„å¯¹è±¡
                    engine.removeObject(selectedObjectId);
                    logAction(`å–æ¶ˆç»„åˆ: ${selectedObjectId}`);
                    selectedObjectId = null;
                }
            }
        };

        // æ›´æ–°å˜æ¢
        window.updateTransform = function() {
            if (!selectedObjectId) return;
            
            const posX = parseFloat(document.getElementById('posX').value) || 0;
            const posY = parseFloat(document.getElementById('posY').value) || 0;
            const posZ = parseFloat(document.getElementById('posZ').value) || 0;
            const rotX = parseFloat(document.getElementById('rotX').value) || 0;
            const rotY = parseFloat(document.getElementById('rotY').value) || 0;
            const rotZ = parseFloat(document.getElementById('rotZ').value) || 0;
            const scaleX = parseFloat(document.getElementById('scaleX').value) || 1;
            const scaleY = parseFloat(document.getElementById('scaleY').value) || 1;
            const scaleZ = parseFloat(document.getElementById('scaleZ').value) || 1;
            
            engine.updateObject(selectedObjectId, {
                transform: {
                    position: new Vector3(posX, posY, posZ),
                    rotation: new Vector3(rotX, rotY, rotZ),
                    scale: new Vector3(scaleX, scaleY, scaleZ)
                }
            });
            
            logAction(`æ›´æ–°å˜æ¢: ${selectedObjectId}`);
        };

        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('canvas');
            renderer.resize(canvas.clientWidth, canvas.clientHeight);
        });

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html> 