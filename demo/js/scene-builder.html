<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœºæ™¯æ„å»º - TripoScript 2.1</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 340px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .viewport {
            flex: 1;
            position: relative;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        h1 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 24px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border-left: 4px solid #00b894;
        }

        .section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 8px;
            margin: 3px 0;
            border: none;
            border-radius: 4px;
            background: #00b894;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #00a085;
            transform: translateY(-1px);
        }

        .scene-templates {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .template-btn {
            padding: 10px;
            font-size: 11px;
            text-align: center;
            background: #74b9ff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0;
        }

        .template-btn:hover {
            background: #0984e3;
        }

        .light-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .light-btn {
            padding: 6px;
            font-size: 12px;
            margin: 0;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .control-group input[type="color"] {
            width: 100%;
            height: 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .control-group select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 184, 148, 0.9);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            z-index: 1000;
        }

        .scene-info {
            background: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 120px;
            overflow-y: auto;
        }

        .environment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }

        .env-btn {
            padding: 8px 4px;
            font-size: 10px;
            text-align: center;
            margin: 0;
        }

        .animation-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .anim-btn {
            flex: 1;
            padding: 6px;
            font-size: 11px;
            margin: 0;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
    
    <div class="container">
        <div class="sidebar">
            <h1>åœºæ™¯æ„å»º</h1>
            
            <div class="section">
                <h3>ğŸ—ï¸ åœºæ™¯æ¨¡æ¿</h3>
                <div class="scene-templates">
                    <button class="template-btn" onclick="buildCityScene()">åŸå¸‚åœºæ™¯</button>
                    <button class="template-btn" onclick="buildForestScene()">æ£®æ—åœºæ™¯</button>
                    <button class="template-btn" onclick="buildMuseumScene()">åšç‰©é¦†</button>
                    <button class="template-btn" onclick="buildWorkshopScene()">å·¥ä½œå®¤</button>
                    <button class="template-btn" onclick="buildSpaceScene()">å¤ªç©ºåœºæ™¯</button>
                    <button class="template-btn" onclick="buildMinimalScene()">æç®€åœºæ™¯</button>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ’¡ å…‰ç…§ç³»ç»Ÿ</h3>
                <div class="light-controls">
                    <button class="light-btn" onclick="addAmbientLight()">ç¯å¢ƒå…‰</button>
                    <button class="light-btn" onclick="addDirectionalLight()">å¹³è¡Œå…‰</button>
                    <button class="light-btn" onclick="addPointLight()">ç‚¹å…‰æº</button>
                    <button class="light-btn" onclick="addSpotLight()">èšå…‰ç¯</button>
                </div>
                
                <div class="control-group">
                    <label>å…¨å±€äº®åº¦: <span id="globalIntensityValue">1.0</span></label>
                    <input type="range" id="globalIntensity" min="0" max="3" step="0.1" value="1" oninput="updateGlobalLighting()">
                </div>

                <div class="control-group">
                    <label>é˜´å½±è´¨é‡:</label>
                    <select id="shadowQuality" onchange="updateShadowQuality()">
                        <option value="low">ä½</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="high">é«˜</option>
                        <option value="ultra">è¶…é«˜</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <h3>ğŸŒ ç¯å¢ƒè®¾ç½®</h3>
                <div class="environment-grid">
                    <button class="env-btn" onclick="setEnvironment('day')">ç™½å¤©</button>
                    <button class="env-btn" onclick="setEnvironment('sunset')">é»„æ˜</button>
                    <button class="env-btn" onclick="setEnvironment('night')">å¤œæ™š</button>
                    <button class="env-btn" onclick="setEnvironment('studio')">æ‘„å½±æ£š</button>
                    <button class="env-btn" onclick="setEnvironment('nature')">è‡ªç„¶</button>
                    <button class="env-btn" onclick="setEnvironment('urban')">éƒ½å¸‚</button>
                </div>

                <div class="control-group">
                    <label>é›¾æ•ˆå¼ºåº¦: <span id="fogDensityValue">0.0</span></label>
                    <input type="range" id="fogDensity" min="0" max="0.1" step="0.001" value="0" oninput="updateFog()">
                </div>

                <div class="control-group">
                    <label>é›¾æ•ˆé¢œè‰²:</label>
                    <input type="color" id="fogColor" value="#cccccc" onchange="updateFog()">
                </div>
            </div>

            <div class="section">
                <h3>ğŸ¬ ç›¸æœºæ§åˆ¶</h3>
                <div class="control-group">
                    <label>è§†è§’ (FOV): <span id="fovValue">75</span>Â°</label>
                    <input type="range" id="fov" min="20" max="120" step="1" value="75" oninput="updateCamera()">
                </div>

                <div class="control-group">
                    <label>ç›¸æœºç±»å‹:</label>
                    <select id="cameraType" onchange="updateCameraType()">
                        <option value="perspective" selected>é€è§†</option>
                        <option value="orthographic">æ­£äº¤</option>
                    </select>
                </div>

                <div class="animation-controls">
                    <button class="anim-btn" onclick="animateCamera('orbit')">è½¨é“åŠ¨ç”»</button>
                    <button class="anim-btn" onclick="animateCamera('flythrough')">é£è¡ŒåŠ¨ç”»</button>
                    <button class="anim-btn" onclick="stopAnimation()">åœæ­¢åŠ¨ç”»</button>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ”§ å¿«é€Ÿæ“ä½œ</h3>
                <button onclick="exportScene()">å¯¼å‡ºåœºæ™¯</button>
                <button onclick="importScene()">å¯¼å…¥åœºæ™¯</button>
                <button onclick="optimizeScene()">ä¼˜åŒ–åœºæ™¯</button>
                <button onclick="resetScene()">é‡ç½®åœºæ™¯</button>
            </div>

            <div class="section">
                <h3>ğŸ“Š åœºæ™¯ä¿¡æ¯</h3>
                <div class="scene-info" id="sceneInfo">
                    å¯¹è±¡æ•°é‡: 0<br>
                    å…‰æºæ•°é‡: 2<br>
                    æè´¨æ•°é‡: 1<br>
                    åœºæ™¯å¤§å°: å°
                </div>
            </div>
        </div>

        <div class="viewport">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script type="module">
        import { TripoEngine, TripoRenderer } from '../../src/index.js';
        import { Vector3 } from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        // å…¨å±€å˜é‡
        let engine, renderer, controls;
        let cameraAnimation = null;
        let animationFrame = 0;

        // ç¯å¢ƒé…ç½®
        const environments = {
            day: { background: '#87CEEB', ambientColor: '#ffffff', ambientIntensity: 0.6, directionalIntensity: 1.0 },
            sunset: { background: '#FF6B35', ambientColor: '#FF8C42', ambientIntensity: 0.8, directionalIntensity: 0.7 },
            night: { background: '#2c3e50', ambientColor: '#34495e', ambientIntensity: 0.3, directionalIntensity: 0.2 },
            studio: { background: '#f8f9fa', ambientColor: '#ffffff', ambientIntensity: 1.0, directionalIntensity: 0.8 },
            nature: { background: '#27ae60', ambientColor: '#2ecc71', ambientIntensity: 0.5, directionalIntensity: 0.9 },
            urban: { background: '#34495e', ambientColor: '#7f8c8d', ambientIntensity: 0.4, directionalIntensity: 0.6 }
        };

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function init() {
            const canvas = document.getElementById('canvas');
            
            // åˆ›å»ºDSLå¼•æ“
            engine = new TripoEngine();
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new TripoRenderer(canvas, engine);
            
            // æ·»åŠ è½¨é“æ§åˆ¶å™¨
            controls = new OrbitControls(
                renderer.getThreeCamera(), 
                renderer.getThreeRenderer().domElement
            );
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // ç›‘å¬åœºæ™¯å˜åŒ–
            engine.subscribe(updateSceneInfo);
            
            // åˆå§‹åŒ–åœºæ™¯
            buildMinimalScene();
            
            // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            animate();
        }

        // æ¸²æŸ“å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            // å¤„ç†ç›¸æœºåŠ¨ç”»
            if (cameraAnimation) {
                handleCameraAnimation();
            }
        }

        // å¤„ç†ç›¸æœºåŠ¨ç”»
        function handleCameraAnimation() {
            animationFrame++;
            const time = animationFrame * 0.01;
            
            if (cameraAnimation === 'orbit') {
                const radius = 15;
                const camera = renderer.getThreeCamera();
                camera.position.x = Math.cos(time) * radius;
                camera.position.z = Math.sin(time) * radius;
                camera.position.y = 5 + Math.sin(time * 0.5) * 3;
                camera.lookAt(0, 0, 0);
            } else if (cameraAnimation === 'flythrough') {
                const camera = renderer.getThreeCamera();
                camera.position.x = Math.sin(time * 0.5) * 20;
                camera.position.y = 5 + Math.cos(time * 0.3) * 5;
                camera.position.z = Math.cos(time * 0.5) * 20;
                camera.lookAt(
                    Math.sin(time * 0.5 + 1) * 5,
                    0,
                    Math.cos(time * 0.5 + 1) * 5
                );
            }
        }

        // æ„å»ºåŸå¸‚åœºæ™¯
        window.buildCityScene = function() {
            clearScene();
            
            // åˆ›å»ºåœ°é¢
            engine.addObject({
                name: 'åœ°é¢',
                type: 'mesh',
                geometry: { type: 'plane', size: new Vector3(50, 50, 1) },
                transform: {
                    position: new Vector3(0, -1, 0),
                    rotation: new Vector3(-Math.PI / 2, 0, 0)
                },
                material: { type: 'standard', color: '#2c3e50' }
            });

            // åˆ›å»ºå»ºç­‘ç¾¤
            for (let i = 0; i < 15; i++) {
                const height = Math.random() * 10 + 3;
                const width = Math.random() * 2 + 1;
                const depth = Math.random() * 2 + 1;
                
                engine.addObject({
                    name: `å»ºç­‘_${i + 1}`,
                    type: 'mesh',
                    geometry: { type: 'box', size: new Vector3(width, height, depth) },
                    transform: {
                        position: new Vector3(
                            (Math.random() - 0.5) * 40,
                            height / 2,
                            (Math.random() - 0.5) * 40
                        )
                    },
                    material: { type: 'standard', color: getRandomCityColor() }
                });
            }
            
            setEnvironment('urban');
            addStreetLights();
        };

        // æ„å»ºæ£®æ—åœºæ™¯
        window.buildForestScene = function() {
            clearScene();
            
            // åˆ›å»ºåœ°é¢
            engine.addObject({
                name: 'è‰åœ°',
                type: 'mesh',
                geometry: { type: 'plane', size: new Vector3(40, 40, 1) },
                transform: {
                    position: new Vector3(0, 0, 0),
                    rotation: new Vector3(-Math.PI / 2, 0, 0)
                },
                material: { type: 'standard', color: '#2ecc71' }
            });

            // åˆ›å»ºæ ‘æœ¨
            for (let i = 0; i < 20; i++) {
                // æ ‘å¹²
                const trunkHeight = Math.random() * 3 + 2;
                engine.addObject({
                    name: `æ ‘å¹²_${i + 1}`,
                    type: 'mesh',
                    geometry: { type: 'cylinder', radius: 0.2, height: trunkHeight, radialSegments: 8 },
                    transform: {
                        position: new Vector3(
                            (Math.random() - 0.5) * 30,
                            trunkHeight / 2,
                            (Math.random() - 0.5) * 30
                        )
                    },
                    material: { type: 'standard', color: '#8b4513' }
                });

                // æ ‘å† 
                engine.addObject({
                    name: `æ ‘å† _${i + 1}`,
                    type: 'mesh',
                    geometry: { type: 'sphere', radius: Math.random() * 2 + 1.5, radialSegments: 12, heightSegments: 8 },
                    transform: {
                        position: new Vector3(
                            (Math.random() - 0.5) * 30,
                            trunkHeight + 1.5,
                            (Math.random() - 0.5) * 30
                        )
                    },
                    material: { type: 'standard', color: '#228b22' }
                });
            }
            
            setEnvironment('nature');
        };

        // æ„å»ºåšç‰©é¦†åœºæ™¯
        window.buildMuseumScene = function() {
            clearScene();
            
            // åšç‰©é¦†åœ°é¢
            engine.addObject({
                name: 'å¤§ç†çŸ³åœ°é¢',
                type: 'mesh',
                geometry: { type: 'plane', size: new Vector3(30, 30, 1) },
                transform: {
                    position: new Vector3(0, 0, 0),
                    rotation: new Vector3(-Math.PI / 2, 0, 0)
                },
                material: { type: 'standard', color: '#f8f8ff', metalness: 0.1, roughness: 0.2 }
            });

            // å±•ç¤ºå°
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2;
                const radius = 8;
                
                // å±•ç¤ºå°åº•åº§
                engine.addObject({
                    name: `å±•ç¤ºå°_${i + 1}`,
                    type: 'mesh',
                    geometry: { type: 'cylinder', radius: 1.5, height: 1.5, radialSegments: 16 },
                    transform: {
                        position: new Vector3(
                            Math.cos(angle) * radius,
                            0.75,
                            Math.sin(angle) * radius
                        )
                    },
                    material: { type: 'standard', color: '#ecf0f1', metalness: 0.2, roughness: 0.3 }
                });

                // å±•å“
                engine.addObject({
                    name: `å±•å“_${i + 1}`,
                    type: 'mesh',
                    geometry: { type: 'sphere', radius: 0.8, radialSegments: 20, heightSegments: 16 },
                    transform: {
                        position: new Vector3(
                            Math.cos(angle) * radius,
                            2.3,
                            Math.sin(angle) * radius
                        )
                    },
                    material: { type: 'standard', color: getRandomArtColor(), metalness: 0.8, roughness: 0.1 }
                });
            }
            
            setEnvironment('studio');
            addMuseumLighting();
        };

        // æ„å»ºå·¥ä½œå®¤åœºæ™¯
        window.buildWorkshopScene = function() {
            clearScene();
            
            // å·¥ä½œå°
            engine.addObject({
                name: 'å·¥ä½œå°',
                type: 'mesh',
                geometry: { type: 'box', size: new Vector3(6, 1, 3) },
                transform: {
                    position: new Vector3(0, 0.5, 0)
                },
                material: { type: 'standard', color: '#8b4513', roughness: 0.8 }
            });

            // å·¥å…·å’Œç‰©å“
            const tools = [
                { name: 'é”¤å­', geom: 'cylinder', pos: [-2, 1.2, 0], color: '#34495e' },
                { name: 'èºä¸åˆ€', geom: 'cylinder', pos: [-1, 1.2, 0.5], color: '#e74c3c' },
                { name: 'æ‰³æ‰‹', geom: 'box', pos: [0, 1.2, -0.5], color: '#95a5a6' },
                { name: 'é’³å­', geom: 'box', pos: [1, 1.2, 0], color: '#2c3e50' },
                { name: 'æµ‹é‡å°º', geom: 'box', pos: [2, 1.2, 0.3], color: '#f39c12' }
            ];

            tools.forEach(tool => {
                engine.addObject({
                    name: tool.name,
                    type: 'mesh',
                    geometry: tool.geom === 'cylinder' 
                        ? { type: 'cylinder', radius: 0.1, height: 0.5, radialSegments: 8 }
                        : { type: 'box', size: new Vector3(0.3, 0.1, 0.1) },
                    transform: {
                        position: new Vector3(...tool.pos)
                    },
                    material: { type: 'standard', color: tool.color, metalness: 0.5, roughness: 0.7 }
                });
            });
            
            setEnvironment('studio');
        };

        // æ„å»ºå¤ªç©ºåœºæ™¯
        window.buildSpaceScene = function() {
            clearScene();
            
            // ç©ºé—´ç«™
            engine.addObject({
                name: 'ç©ºé—´ç«™æ ¸å¿ƒ',
                type: 'mesh',
                geometry: { type: 'sphere', radius: 2, radialSegments: 16, heightSegments: 12 },
                transform: {
                    position: new Vector3(0, 0, 0)
                },
                material: { type: 'standard', color: '#bdc3c7', metalness: 0.9, roughness: 0.1 }
            });

            // å¤ªé˜³èƒ½æ¿
            for (let i = 0; i < 4; i++) {
                const angle = (i / 4) * Math.PI * 2;
                engine.addObject({
                    name: `å¤ªé˜³èƒ½æ¿_${i + 1}`,
                    type: 'mesh',
                    geometry: { type: 'box', size: new Vector3(4, 0.1, 2) },
                    transform: {
                        position: new Vector3(
                            Math.cos(angle) * 4,
                            0,
                            Math.sin(angle) * 4
                        ),
                        rotation: new Vector3(0, angle, 0)
                    },
                    material: { type: 'standard', color: '#2c3e50', metalness: 0.3, roughness: 0.7 }
                });
            }

            // æ˜Ÿæ˜Ÿ
            for (let i = 0; i < 50; i++) {
                engine.addObject({
                    name: `æ˜Ÿæ˜Ÿ_${i + 1}`,
                    type: 'mesh',
                    geometry: { type: 'sphere', radius: 0.1, radialSegments: 6, heightSegments: 4 },
                    transform: {
                        position: new Vector3(
                            (Math.random() - 0.5) * 100,
                            (Math.random() - 0.5) * 100,
                            (Math.random() - 0.5) * 100
                        )
                    },
                    material: { type: 'standard', color: '#ffffff', emissive: '#ffffff', emissiveIntensity: 0.5 }
                });
            }
            
            setEnvironment('night');
        };

        // æ„å»ºæç®€åœºæ™¯
        window.buildMinimalScene = function() {
            clearScene();
            
            // ç®€å•çš„å‡ ä½•ä½“ç»„åˆ
            engine.addObject({
                name: 'ç«‹æ–¹ä½“',
                type: 'mesh',
                geometry: { type: 'box', size: new Vector3(2, 2, 2) },
                transform: {
                    position: new Vector3(-3, 1, 0)
                },
                material: { type: 'standard', color: '#3498db' }
            });

            engine.addObject({
                name: 'çƒä½“',
                type: 'mesh',
                geometry: { type: 'sphere', radius: 1, radialSegments: 16, heightSegments: 12 },
                transform: {
                    position: new Vector3(0, 1, 0)
                },
                material: { type: 'standard', color: '#e74c3c' }
            });

            engine.addObject({
                name: 'åœ†æŸ±ä½“',
                type: 'mesh',
                geometry: { type: 'cylinder', radius: 1, height: 2, radialSegments: 16 },
                transform: {
                    position: new Vector3(3, 1, 0)
                },
                material: { type: 'standard', color: '#2ecc71' }
            });

            // åœ°é¢
            engine.addObject({
                name: 'åœ°é¢',
                type: 'mesh',
                geometry: { type: 'plane', size: new Vector3(20, 20, 1) },
                transform: {
                    position: new Vector3(0, 0, 0),
                    rotation: new Vector3(-Math.PI / 2, 0, 0)
                },
                material: { type: 'standard', color: '#ecf0f1' }
            });
            
            setEnvironment('studio');
        };

        // è®¾ç½®ç¯å¢ƒ
        window.setEnvironment = function(envType) {
            const env = environments[envType];
            if (!env) return;

            // æ›´æ–°èƒŒæ™¯
            const threeScene = renderer.getThreeScene();
            threeScene.background = new THREE.Color(env.background);

            // æ›´æ–°ç¯å¢ƒå…‰
            const scene = engine.getScene();
            const ambientLight = scene.lights.find(light => light.type === 'ambient');
            if (ambientLight) {
                engine.dispatch({
                    type: 'UPDATE_LIGHT',
                    payload: {
                        id: ambientLight.id,
                        changes: {
                            color: env.ambientColor,
                            intensity: env.ambientIntensity
                        }
                    }
                });
            }

            // æ›´æ–°å¹³è¡Œå…‰
            const directionalLight = scene.lights.find(light => light.type === 'directional');
            if (directionalLight) {
                engine.dispatch({
                    type: 'UPDATE_LIGHT',
                    payload: {
                        id: directionalLight.id,
                        changes: {
                            intensity: env.directionalIntensity
                        }
                    }
                });
            }
        };

        // æ·»åŠ å„ç§å…‰æº
        window.addAmbientLight = function() {
            engine.addLight({
                type: 'ambient',
                color: '#ffffff',
                intensity: 0.5
            });
        };

        window.addDirectionalLight = function() {
            engine.addLight({
                type: 'directional',
                color: '#ffffff',
                intensity: 0.8,
                position: new Vector3(5, 10, 5),
                target: new Vector3(0, 0, 0)
            });
        };

        window.addPointLight = function() {
            engine.addLight({
                type: 'point',
                color: '#ffffff',
                intensity: 1.0,
                position: new Vector3(0, 5, 0),
                distance: 20
            });
        };

        window.addSpotLight = function() {
            engine.addLight({
                type: 'spot',
                color: '#ffffff',
                intensity: 1.0,
                position: new Vector3(0, 10, 0),
                target: new Vector3(0, 0, 0),
                angle: Math.PI / 6,
                penumbra: 0.2
            });
        };

        // æ›´æ–°å…¨å±€å…‰ç…§
        window.updateGlobalLighting = function() {
            const intensity = parseFloat(document.getElementById('globalIntensity').value);
            document.getElementById('globalIntensityValue').textContent = intensity.toFixed(1);
            
            const scene = engine.getScene();
            scene.lights.forEach(light => {
                engine.dispatch({
                    type: 'UPDATE_LIGHT',
                    payload: {
                        id: light.id,
                        changes: { intensity: light.intensity * intensity }
                    }
                });
            });
        };

        // æ›´æ–°é˜´å½±è´¨é‡
        window.updateShadowQuality = function() {
            const quality = document.getElementById('shadowQuality').value;
            const renderer = window.renderer?.getThreeRenderer();
            if (renderer) {
                const shadowMap = renderer.shadowMap;
                switch (quality) {
                    case 'low':
                        shadowMap.mapSize.setScalar(512);
                        break;
                    case 'medium':
                        shadowMap.mapSize.setScalar(1024);
                        break;
                    case 'high':
                        shadowMap.mapSize.setScalar(2048);
                        break;
                    case 'ultra':
                        shadowMap.mapSize.setScalar(4096);
                        break;
                }
            }
        };

        // æ›´æ–°é›¾æ•ˆ
        window.updateFog = function() {
            const density = parseFloat(document.getElementById('fogDensity').value);
            const color = document.getElementById('fogColor').value;
            
            document.getElementById('fogDensityValue').textContent = density.toFixed(3);
            
            const threeScene = renderer.getThreeScene();
            if (density > 0) {
                threeScene.fog = new THREE.FogExp2(color, density);
            } else {
                threeScene.fog = null;
            }
        };

        // æ›´æ–°ç›¸æœº
        window.updateCamera = function() {
            const fov = parseInt(document.getElementById('fov').value);
            document.getElementById('fovValue').textContent = fov;
            
            const camera = renderer.getThreeCamera();
            if (camera.type === 'PerspectiveCamera') {
                camera.fov = fov;
                camera.updateProjectionMatrix();
            }
        };

        // æ›´æ–°ç›¸æœºç±»å‹
        window.updateCameraType = function() {
            const type = document.getElementById('cameraType').value;
            // è¿™é‡Œéœ€è¦æ¸²æŸ“å™¨æ”¯æŒåˆ‡æ¢ç›¸æœºç±»å‹
            console.log('åˆ‡æ¢ç›¸æœºç±»å‹åˆ°:', type);
        };

        // ç›¸æœºåŠ¨ç”»æ§åˆ¶
        window.animateCamera = function(type) {
            cameraAnimation = type;
            animationFrame = 0;
        };

        window.stopAnimation = function() {
            cameraAnimation = null;
        };

        // åœºæ™¯æ“ä½œ
        window.exportScene = function() {
            const scene = engine.exportScene();
            const blob = new Blob([JSON.stringify(scene, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scene.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        window.importScene = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const scene = JSON.parse(e.target.result);
                            engine.importScene(scene);
                        } catch (error) {
                            alert('æ— æ³•å¯¼å…¥åœºæ™¯æ–‡ä»¶');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };

        window.optimizeScene = function() {
            // åˆå¹¶ç›¸ä¼¼æè´¨ï¼Œç§»é™¤é‡å¤å¯¹è±¡ç­‰ä¼˜åŒ–æ“ä½œ
            console.log('ä¼˜åŒ–åœºæ™¯...');
        };

        window.resetScene = function() {
            if (confirm('ç¡®å®šè¦é‡ç½®åœºæ™¯å—ï¼Ÿ')) {
                buildMinimalScene();
            }
        };

        // è¾…åŠ©å‡½æ•°
        function clearScene() {
            const scene = engine.getScene();
            scene.objects.forEach(obj => {
                engine.removeObject(obj.id);
            });
        }

        function getRandomCityColor() {
            const colors = ['#34495e', '#2c3e50', '#7f8c8d', '#95a5a6', '#bdc3c7'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getRandomArtColor() {
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function addStreetLights() {
            for (let i = 0; i < 5; i++) {
                engine.addLight({
                    type: 'point',
                    color: '#ffa500',
                    intensity: 0.8,
                    position: new Vector3(
                        (Math.random() - 0.5) * 30,
                        8,
                        (Math.random() - 0.5) * 30
                    ),
                    distance: 15
                });
            }
        }

        function addMuseumLighting() {
            // é¡¶éƒ¨èšå…‰ç¯
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2;
                const radius = 8;
                
                engine.addLight({
                    type: 'spot',
                    color: '#ffffff',
                    intensity: 0.8,
                    position: new Vector3(
                        Math.cos(angle) * radius,
                        8,
                        Math.sin(angle) * radius
                    ),
                    target: new Vector3(
                        Math.cos(angle) * radius,
                        0,
                        Math.sin(angle) * radius
                    ),
                    angle: Math.PI / 8,
                    penumbra: 0.3
                });
            }
        }

        function updateSceneInfo(scene) {
            const info = document.getElementById('sceneInfo');
            const objectCount = scene.objects.length;
            const lightCount = scene.lights.length;
            const materialCount = scene.materials.length;
            const sceneSize = objectCount < 10 ? 'å°' : objectCount < 30 ? 'ä¸­' : 'å¤§';
            
            info.innerHTML = `
                å¯¹è±¡æ•°é‡: ${objectCount}<br>
                å…‰æºæ•°é‡: ${lightCount}<br>
                æè´¨æ•°é‡: ${materialCount}<br>
                åœºæ™¯å¤§å°: ${sceneSize}
            `;
        }

        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('canvas');
            renderer.resize(canvas.clientWidth, canvas.clientHeight);
        });

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html> 